---
import { contentfulClient } from '../../lib/contentful';
import type { Project } from '../../lib/contentful';
import { documentToHtmlString } from '@contentful/rich-text-html-renderer';
import { BLOCKS } from '@contentful/rich-text-types';

let project;
const { slug } = Astro.params;

const options = {
  renderNode: {
    [BLOCKS.EMBEDDED_ASSET]: ({
      data: {
        target: { fields },
      },
    }) =>
      `<img src="${fields.file.url}" height="${fields.file.details.image.height / 10}" width="${fields.file.details.image.width / 10}" alt="${fields.description}"/>`,
  },
};

try {
  const data = await contentfulClient.getEntries<Project>({
    content_type: 'project',
    'fields.slug': slug,
  });
  const { title, date, image, content } = data.items[0].fields;
  project = {
    title,
    date: new Date(date).toLocaleDateString(),
    image: image.fields.file.url,
    content: documentToHtmlString(content, options),
  };
} catch (error) {
  return Astro.redirect('/404');
}
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{project?.title}</title>
  </head>
  <body>
    <h1>{project?.title}</h1>
    <h2>{project?.date}</h2>
    <img src={project?.image} />
    <article set:html={project?.content} />
  </body>
</html>

<style>
  img {
    width: 50%;
  }

  article .blurbImage {
    width: 50%;
  }
</style>
